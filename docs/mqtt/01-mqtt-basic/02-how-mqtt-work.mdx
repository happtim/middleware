---
    title: 'MQTT 如何工作'
---

在上节课里我们了解了MQTT协议的背景知识和基本特点,这节课我们一起了解MQTT的基本工作原理.

在MQTT协议通讯中,有几个个最为重要的概念.它们分别是:

* Server (=broker 服务端)
* Client (=publisher,subscriber 客户端)
* Pub-sub (发布订阅)
* Session (会话)
* Topic (话题)。

首先我们来初步了解一下它们。

### Server (服务端)

MQTT服务端通常是一台服务器(broker).它是MQTT信息传输的枢纽,负责将MQTT客户端发送来的信息传递给MQTT客户端.
MQTT服务端还负责管理MQTT客户端. 确保客户端之间的通讯顺畅,保证MQTT消息得以正确接收和准确投递.

### Client (客户端)

MQTT客户端可以向服务端发布信息(publisher),也可以从服务端收取信息(subscriber).
客户端不会直接相互发送消息,而是与 MQTT 代理管理的主题进行通信.
我们把客户端发送信息的行为成为 publish(发布) 信息.而客户端要想从服务端收取信息,则首先要向服务端 subscribe(订阅)信息.

### (Pub-sub)发布订阅模型

MQTT 协议在网络中定义了两种类型的实体：消息代理和许多客户端。
代理是一个服务器，它接收来自客户端的所有消息，然后将这些消息路由到相关的目标客户端。
客户端是可以与代理交互以发送和接收消息的任何内容。
客户端可以是现场的 IoT 传感器，也可以是处理 IoT 数据的数据中心中的应用程序。

* 客户端连接到代理。它可以订阅代理中的任何消息"主题"。此连接可以是普通 TCP/IP 连接，也可以是敏感邮件的加密 TLS 连接。
* 客户端通过将消息和主题发送到代理来发布主题下的消息。
* 然后，代理将消息转发给订阅该主题的所有客户端。

由于 MQTT 消息是按主题组织的，因此应用程序开发人员可以灵活地指定某些客户端只能与某些消息进行交互。例如，传感器将在"sensor_data"主题下发布其读数，并订阅"config_change"主题。
将传感器数据保存到后端数据库的数据处理应用程序将订阅"sensor_data"主题。管理控制台应用程序可以接收系统管理员的命令，以调整传感器的配置（如灵敏度和采样频率），并将这些更改发布到"config_change"主题。

import PublishSubscribeModelSvg from './assets/publish-subscribe-model.drawio.svg'

<PublishSubscribeModelSvg />

*The MQTT publish and subscribe model for IoT sensors*


同时，MQTT是轻量级的。它有一个简单的标头来指定消息类型、基于文本的主题，然后是任意二进制负载。应用程序可以为有效负载使用任何数据格式，例如 JSON、XML、加密二进制文件或 Base64，只要目标客户端可以分析有效负载即可。

### Session (会话)

从从客户端向服务器发起 MQTT 连接请求开始，直到连接中断且会话过期的消息系列称为会话。
因此，会话可能只持续一个网络连接，或者如果客户端可以在会话过期之前重新建立连接，则该会话可能存在于多个网络连接中。

### Topic (话题)

MQTT 消息不会直接从 Thing 传递到另一个 Thing。相反，它们被发布到"主题"。然后，代理将这些消息传递到任何已订阅的客户端。

从技术上讲，主题是消息队列。主题支持 发布/订阅模式 客户。
从逻辑上讲，主题允许客户端使用定义的语义交换信息。 示例主题：建筑物的温度传感器数据。
